# Bosun tmux configuration
# Optimized for multi-agent workflow

# ============================================
# General Settings
# ============================================

set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",xterm-256color:Tc"

set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on
set -g history-limit 50000
set -s escape-time 0
set -g mouse on
set -g focus-events on
set -g display-panes-time 3000
setw -g monitor-activity on
set -g visual-activity off

# ============================================
# Key Bindings
# ============================================

# Prefix: Ctrl+A
unbind C-b
set -g prefix C-a
bind C-a send-prefix

# Reload config
bind r run-shell 'tmux source-file "$BOSUN_ROOT/config/tmux.conf"' \; display "Config reloaded!"

# Split panes
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
unbind '"'
unbind %

# Navigate panes (no prefix)
bind -n M-Left select-pane -L
bind -n M-Right select-pane -R
bind -n M-Up select-pane -U
bind -n M-Down select-pane -D

# Navigate windows (no prefix)
bind -n S-Left previous-window
bind -n S-Right next-window

# Quick window switching (no prefix)
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-0 last-window

# Session switching
bind -n M-s choose-tree -Zs
bind -n S-Up switch-client -p
bind -n S-Down switch-client -n
bind ` switch-client -l

# Spawn new bosun agent in a window (prefix + n)
bind n run-shell 'N=$($BOSUN_ROOT/scripts/tmux-next-bosun.sh); tmux new-window -n "bosun-$N" -e PI_AGENT=bosun -e "PI_AGENT_NAME=bosun-$N" "$BOSUN_ROOT/scripts/sandbox.sh pi"'

# Spawn new bosun agent in a session (prefix + N)
bind N run-shell 'N=$($BOSUN_ROOT/scripts/tmux-next-bosun.sh); tmux new-session -d -s "bosun-$N" -n "bosun-$N" -c "$BOSUN_ROOT" -e PI_AGENT=bosun -e "PI_AGENT_NAME=bosun-$N" "$BOSUN_ROOT/scripts/sandbox.sh pi"; tmux switch-client -t "bosun-$N"'

# Window management
bind c new-window -c "#{pane_current_path}"
bind x kill-pane
bind X kill-window
bind Tab choose-tree -Zw
bind z select-window -t 1
bind , command-prompt -I "#W" "rename-window '%%'"
bind . command-prompt -I "#S" "rename-session '%%'"
bind -r < swap-window -t -1 \; previous-window
bind -r > swap-window -t +1 \; next-window

# ============================================
# Status Bar
# ============================================

set -g status-interval 5
set -g status-position top

# Dark theme
set -g status-style "bg=#1a1b26,fg=#a9b1d6"
set -g status-left-length 30
set -g status-left "#[fg=#7aa2f7,bold] #S #[fg=#565f89]│ "
set -g status-right-length 50
set -g status-right "#[fg=#565f89]│ #[fg=#9ece6a]%H:%M #[fg=#565f89]│ #[fg=#bb9af7]%b %d "

# Window status
set -g window-status-format "#[fg=#565f89] #I:#W "
set -g window-status-current-format "#[fg=#1a1b26,bg=#7aa2f7,bold] #I:#W "
set -g window-status-separator ""

# Pane borders
set -g pane-border-style "fg=#3b4261"
set -g pane-active-border-style "fg=#7aa2f7"

# Message style
set -g message-style "bg=#1a1b26,fg=#7aa2f7"

# ============================================
# Window Names
# ============================================

set -g allow-rename off
setw -g automatic-rename off

# ============================================
# Copy Mode (vi-style)
# ============================================

setw -g mode-keys vi
bind [ copy-mode
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi y send -X copy-selection-and-cancel
bind -T copy-mode-vi Escape send -X cancel

# Scrollback in editor
bind e capture-pane -S -32768 \; save-buffer /tmp/tmux-scrollback.txt \; delete-buffer \; popup -w 90% -h 90% -E 'nvim +$ /tmp/tmux-scrollback.txt'

# ============================================
# Help
# ============================================

bind ? display-popup -w 60 -h 28 -E '\
echo "Bosun tmux cheatsheet"; \
echo "====================="; \
echo ""; \
echo "PREFIX: Ctrl+A"; \
echo ""; \
echo "NO PREFIX NEEDED:"; \
echo "  Alt+Arrow    Navigate panes"; \
echo "  Shift+L/R    Prev/next window"; \
echo "  Alt+1-5      Jump to window"; \
echo "  Alt+0        Toggle last window"; \
echo "  Alt+s        Session picker"; \
echo ""; \
echo "WITH PREFIX (Ctrl+A):"; \
echo "  |  Split horizontal"; \
echo "  -  Split vertical"; \
echo "  n  New bosun window"; \
echo "  N  New bosun session"; \
echo "  c  New empty window"; \
echo "  ,  Rename window"; \
echo "  .  Rename session"; \
echo "  < >  Swap window left/right"; \
echo "  z  Jump to window 1"; \
echo "  x  Kill pane"; \
echo "  X  Kill window"; \
echo "  Tab  Window picker"; \
echo "  [  Copy mode (vi)"; \
echo "  e  Scrollback in editor"; \
echo "  r  Reload config"; \
echo "  ?  This help"; \
echo ""; \
echo "[Enter to close]"; \
read'
